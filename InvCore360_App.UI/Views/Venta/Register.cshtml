@model InvCore360_App.UI.Controllers.VentaController.SaleDto

@{
    ViewData["Title"] = "Registrar Venta";
}

<h1>Registrar Venta</h1>

<div class="card p-4">
    <div class="mb-3">
        <label class="form-label">Usuario</label>
        <select id="usuarioSelect" class="form-select"></select>
    </div>

    <div class="mb-3">
        <label class="form-label">Método de pago</label>
        <select id="metodoPago" class="form-select">
            <option>EFECTIVO</option>
            <option>TARJETA</option>
            <option>TRANSFERENCIA</option>
        </select>
    </div>

    <hr />

    <h5>Detalles</h5>
    <div id="detallesContainer"></div>
    <div class="d-flex gap-2 mt-3">
        <select id="productoSelect" class="form-select w-50"></select>
        <input id="cantidadInput" type="number" min="1" value="1" class="form-control w-25" />
        <button id="addDetalle" class="btn btn-primary">Agregar</button>
    </div>

    <hr />

    <div class="mt-3 text-end">
        <div class="mb-2">Subtotal: <span id="subtotal">0.00</span></div>
        <div class="mb-2">Impuesto: <span id="impuesto">0.00</span></div>
        <div class="mb-2">Descuento: <span id="descuento">0.00</span></div>
        <h4>Total: <span id="total">0.00</span></h4>
        <button id="submitSale" class="btn btn-success mt-3">Registrar Venta</button>
    </div>
</div>

@section Scripts {
    <script>
        const apiProductos = '/api/api/productos';
        const apiUsuarios = '/api/api/usuarios';

        let productos = [];
        let detalles = [];

        async function loadProductos() {
            const res = await fetch(apiProductos);
            productos = await res.json();
            const sel = document.getElementById('productoSelect');
            sel.innerHTML = '';
            productos.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.productoID;
                opt.text = `${p.nombre} - ${p.precioVenta}`;
                sel.appendChild(opt);
            });
        }

        async function loadUsuarios() {
            const res = await fetch(apiUsuarios);
            const usuarios = await res.json();
            const sel = document.getElementById('usuarioSelect');
            sel.innerHTML = '';
            usuarios.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.usuarioID;
                opt.text = u.nombreCompleto;
                sel.appendChild(opt);
            });
        }

        function renderDetalles() {
            const cont = document.getElementById('detallesContainer');
            cont.innerHTML = '';
            let subtotal = 0;
            detalles.forEach((d, idx) => {
                const row = document.createElement('div');
                row.className = 'd-flex justify-content-between align-items-center py-2 border-bottom';
                row.innerHTML = `
                    <div>${d.nombreProducto} x ${d.cantidad}</div>
                    <div>${(d.precioUnitario * d.cantidad).toFixed(2)}</div>
                    <div><button class='btn btn-sm btn-danger' data-idx='${idx}'>Quitar</button></div>
                `;
                cont.appendChild(row);
                subtotal += d.precioUnitario * d.cantidad;
            });
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            const impuesto = subtotal * 0.13; // ejemplo 13%
            document.getElementById('impuesto').textContent = impuesto.toFixed(2);
            document.getElementById('descuento').textContent = '0.00';
            document.getElementById('total').textContent = (subtotal + impuesto).toFixed(2);

            cont.querySelectorAll('button[data-idx]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.getAttribute('data-idx'));
                    detalles.splice(idx,1);
                    renderDetalles();
                });
            });
        }

        document.getElementById('addDetalle').addEventListener('click', (e) => {
            e.preventDefault();
            const prodId = parseInt(document.getElementById('productoSelect').value);
            const cantidad = parseInt(document.getElementById('cantidadInput').value) || 1;
            const prod = productos.find(p => p.productoID === prodId);
            if (!prod) return;
            const det = { productoID: prod.productoID, nombreProducto: prod.nombre, cantidad: cantidad, precioUnitario: prod.precioVenta, descuento: 0 };
            detalles.push(det);
            renderDetalles();
        });

        document.getElementById('submitSale').addEventListener('click', async (e) => {
            e.preventDefault();
            if (detalles.length === 0) { alert('Agregar al menos un detalle'); return; }
            const subtotal = parseFloat(document.getElementById('subtotal').textContent);
            const impuesto = parseFloat(document.getElementById('impuesto').textContent);
            const total = parseFloat(document.getElementById('total').textContent);
            const metodoPago = document.getElementById('metodoPago').value;
            const usuarioID = parseInt(document.getElementById('usuarioSelect').value);

            const payload = { subtotal, impuesto, descuento: 0, total, metodoPago, usuarioID, observaciones: null, detalles };

            const res = await fetch('/Venta/RegisterSale', {
                method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' }
            });

            if (res.ok) {
                alert('Venta registrada con éxito');
                window.location.href = '/Venta/Index';
            } else {
                const text = await res.text();
                alert('Error: ' + text);
            }
        });

        // inicial
        loadProductos();
        loadUsuarios();
    </script>
}
